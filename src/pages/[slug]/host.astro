---
import Layout from '../../layouts/Layout.astro';
import HostDashboard from '../../components/HostDashboard.astro';
const { slug } = Astro.params;
let siteURL = Astro.url.origin;

// try {
// 	const sessionsResponse = await fetch(siteURL+'/.netlify/functions/get_sessions');
// 	sessionsJSON = await sessionsResponse.json();
// 	sessions = sessionsJSON.filter(session => session.slug===Astro.url.pathname.replaceAll('/',''));
// 	// console.log("sessions details: ", sessions);
//     if (sessions.length === 0){
//         return Astro.redirect('/');
//     } else {
// 		session = sessions[0];
// 		console.log("session details: ", session);
// 	}
// } catch (error){
// 	console.log("Error getting sessions: ", error);
// }


---

<Layout title="Welcome to Astro.">

    <section data-slug={slug}>
        <div id="login">
            <!-- /Host
            <h1>{slug}</h1>
            {Astro.url.origin + '/.netlify/identity/authorize?provider=github'}
            <div data-netlify-identity-button>Login with Netlify Identity</div> -->
            <a href="https://harmonious-peony-c339d6.netlify.app/.netlify/identity/authorize?provider=github">login with GitHub</a>
            <div id="status"></div>
        </div>
        <div id="dashboard">
            <button id="logout">logout</button>
            <HostDashboard />
        </div>
        
    </section>

</Layout>

<script>
    console.log("host!");
    console.log("header height: ", document.querySelector("header").clientHeight)
    console.log("footer height: ", document.querySelector("footer").clientHeight)
    const dashboardEl : HTMLDivElement = document.querySelector("#dashboard"); 
    const statusEl = document.querySelector("#status"); 
    const loginEl : HTMLDivElement = document.querySelector("#login");
    loginEl.style.height = `calc( 100vh - ${document.querySelector("header").clientHeight}px - ${document.querySelector("footer").clientHeight}px - 10px)` 
    // loginEl.style.height = `calc( 100vh - ${headerHeight}px)` 
    const slug = document.querySelector("section").dataset.slug;
    const netlifyIdentity = (window as any).netlifyIdentity;
    netlifyIdentity.on('init', user => console.log('init', user));
    netlifyIdentity.on('login', async (user) => {
        console.log('login', user);
        // check if authorized
        statusEl.textContent = "authorizing..."
        const data = {slug}
        console.log("data: ", data);
        const response = await fetch("/.netlify/functions/is_host", {
            method: 'POST', // *GET, POST, PUT, DELETE, etc.
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + user.token.access_token
            },
            body: JSON.stringify(data) // body data type must match "Content-Type" header
        });
        const isHost = await response.json();
        console.log("isHost: ",isHost);
        if (isHost.authorized){
            loginEl.style.display = "none";
            dashboardEl.style.display = "block";
            sessionStorage.setItem("session", JSON.stringify(isHost.session));
            // const sessionId = isHost.session.sessionId;
        } else {
            statusEl.textContent = "not authorized."
        }

        console.log("inputs-select: ",document.querySelector("inputs-select"))
        console.log("hidden: ",document.querySelector("#hidden"))

    });

    netlifyIdentity.on('logout', () => {
        console.log('Logged out')
        loginEl.style.display = "grid";
        dashboardEl.style.display = "none";
    });
    netlifyIdentity.on('error', err => console.error('Error', err));
    netlifyIdentity.on('open', () => console.log('Widget opened'));
    netlifyIdentity.on('close', () => console.log('Widget closed'));

    const logoutBtn = document.querySelector('#logout');
    logoutBtn.addEventListener("click", ()=>{
        console.log("logout!");
        netlifyIdentity.logout();
    });
</script>
<script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
<!-- Load Vonage Video API fka OpenTok -->
<!-- <script src="https://static.opentok.com/v2/js/opentok.min.js"></script> -->
<script src="https://unpkg.com/@vonage/video-client@latest/dist/js/opentok.min.js"></script>
<script is:inline type="module" src="https://unpkg.com/@vonage/inputs-select@latest/inputs-select.js?module"></script>
<script is:inline type="module" src="https://unpkg.com/@vonage/video-publisher@latest/video-publisher.js?module"></script>


<style>
    section {
        height: 100%;
    }
    #login {
        width: 100%;
        height: 100vh;
        display: grid;
        place-items: center;
        place-content: center;
        justify-content: center;
    }
    #dashboard {
        display: none;
    }
    #logout {
        position: absolute;
        right: 5px;
    }
</style>